doctype html
html(lang='en')
  head
    meta(charset='utf-8')
    link(rel='apple-touch-icon', sizes='76x76', href='/assets/assets/img/apple-icon.png')
    link(rel='icon', type='image/png', sizes='96x96', href='/assets/assets/img/favicon.png')
    meta(http-equiv='X-UA-Compatible', content='IE=edge,chrome=1')
    title Online Booking and Spa Management System
    meta(content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0', name='viewport')
    meta(name='viewport', content='width=device-width')
    // Bootstrap core CSS
    link(href='/assets/paperDashboardPro/css/bootstrap.min.css', rel='stylesheet')
    // Paper Dashboard core CSS
    link(href='/assets/paperDashboardPro/css/paper-dashboard.css?v=1.2.1', rel='stylesheet')
    // CSS for Demo Purpose, don't include it in your project
    link(href='/assets/paperDashboardPro/css/demo.css', rel='stylesheet')
    // Fonts and icons
    link(href='https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css', rel='stylesheet')
    link(href='https://fonts.googleapis.com/css?family=Muli:400,300', rel='stylesheet', type='text/css')
    link(href='/assets/paperDashboardPro/css/themify-icons.css', rel='stylesheet')
    link(href='/assets/paperDashboardPro/css/fullcalendar.css', rel='stylesheet')
    link(href='/assets/paperDashboardPro/css/scheduler.css', rel='stylesheet')
    //- style.
    //-   .pull-right .dropdown-menu:after {
    //-     left: 10em;
        
    //-       }
    //-   .pull-right .dropdown-menu {
    //-       left: 10em;
          
    //-   }
  body.sidebar-mini
    .wrapper
      .sidebar(data-background-color='white', data-active-color='spa')
        //
          Tip 1: you can change the color of the sidebar's background using: data-background-color="white | brown"
          Tip 2: you can change the color of the active button using the data-active-color="primary | info | success | warning | danger"
        .logo
          a.simple-text.logo-mini(href='https://www.creative-tim.com')
            | CT
          a.simple-text.logo-normal(href='https://www.creative-tim.com')
            | Creative Tim
        .sidebar-wrapper
          .user
            .info
              .photo
                img(src='/assets/paperDashboardPro/img/icon.jpg')
              a.collapsed(data-toggle='collapse', href='#collapseExample')
                span
                  | Front Desk
              .clearfix
          ul.nav
            li
              a(href='/frontdesk/home')
                i.ti-pencil
                p
                  | Registration
            li.active
              a(href='./fdReservation')
                i.ti-calendar
                p
                  | Reservation
            li
              a(href='./payment')
                i.ti-credit-card
                p
                  | Payment
            li
              a(href='./giftcert')
                i.ti-gift
                p
                  | Gift Certification            
      .main-panel
        nav.navbar.navbar-default
          .container-fluid
            .navbar-minimize
              button#minimizeSidebar.btn.btn-fill.btn-icon
                i.ti-more-alt
            .navbar-header
              button.navbar-toggle(type='button')
                span.sr-only Toggle navigation
                span.icon-bar.bar1
                span.icon-bar.bar2
                span.icon-bar.bar3
              a.navbar-brand(href='#calendar') Calendar
            .collapse.navbar-collapse
              form.navbar-form.navbar-left.navbar-search-form(role='search')
                .input-group
                  span.input-group-addon
                    i.fa.fa-search
                  input.form-control(type='text', value='', placeholder='Search...')
              ul.nav.navbar-nav.navbar-right
                li
                  a#date-part(style="color: black")
                li
                  a#time-part(style="color: black") 
                li
                  a.logout(style="cursor: pointer; color: black") Log Out
        .content
          .container-fluid
            .row
              //- .col-md-10.col-md-offset-1
              .card.card-calendar
                .card-content
                  input(type="hidden" value=`${customerId}` id="Id")
                  input(type='hidden' value=`${customerId}` id="Id")
                  input(type='hidden' id="restype" value=`${restype}`)
                  input(type='hidden' value=`Male: ${male}`)
                  input(type='hidden' value=`Female: ${female}`)
                  #fullCalendar
        
        //VIEW SPECIFIC SCHEDULE
        #viewDateSchedule.modal.fade(tabindex='-1', role='dialog', aria-labelledby='exampleModalLabel', aria-hidden='true')
          .modal-dialog.modal-lg(role='document')
            .modal-content
              .modal-header
                button.close(type='button', data-dismiss='modal', aria-label='Close')
                  span(aria-hidden='true') ×
                center
                  h4.modal-title
              .modal-body#viewAppend
        footer.footer
          .container-fluid
            .copyright.pull-right
              | © 
              script.
                document.write(new Date().getFullYear())
              | , made with 
              i.fa.fa-heart.heart
              |  by 
              a(href='#') Team MBAY
  // Core JS Files. Extra: TouchPunch for touch library inside jquery-ui.min.js
  script(src='/assets/paperDashboardPro/js/jquery-3.1.1.min.js', type='text/javascript')
  script(src='/assets/paperDashboardPro/js/jquery-ui.min.js', type='text/javascript')
  script(src='/assets/paperDashboardPro/js/perfect-scrollbar.min.js', type='text/javascript')
  script(src='/assets/paperDashboardPro/js/bootstrap.min.js', type='text/javascript')
  // Forms Validations Plugin
  script(src='/assets/paperDashboardPro/js/jquery.validate.min.js')
  // Promise Library for SweetAlert2 working on IE
  script(src='/assets/paperDashboardPro/js/es6-promise-auto.min.js')
  // Plugin for Date Time Picker and Full Calendar Plugin
  script(src='/assets/paperDashboardPro/js/moment.min.js')
  // Date Time Picker Plugin is included in this js file
  script(src='/assets/paperDashboardPro/js/bootstrap-datetimepicker.js')
  // Select Picker Plugin
  script(src='/assets/paperDashboardPro/js/bootstrap-selectpicker.js')
  // Switch and Tags Input Plugins
  script(src='/assets/paperDashboardPro/js/bootstrap-switch-tags.js')
  // Circle Percentage-chart
  script(src='/assets/paperDashboardPro/js/jquery.easypiechart.min.js')
  // Charts Plugin
  script(src='/assets/paperDashboardPro/js/chartist.min.js')
  // Notifications Plugin
  script(src='/assets/paperDashboardPro/js/bootstrap-notify.js')
  // Sweet Alert 2 plugin
  script(src='/assets/paperDashboardPro/js/sweetalert.js')
  // Vector Map plugin
  script(src='/assets/paperDashboardPro/js/jquery-jvectormap.js')
  // Wizard Plugin
  script(src='/assets/paperDashboardPro/js/jquery.bootstrap.wizard.min.js')
  // Bootstrap Table Plugin
  script(src='/assets/paperDashboardPro/js/bootstrap-table.js')
  // Plugin for DataTables.net
  script(src='/assets/paperDashboardPro/js/jquery.datatables.js')
  // Full Calendar Plugin
  script(src='/assets/paperDashboardPro/js/fullcalendar.js')
  // Paper Dashboard PRO Core javascript and methods for Demo purpose
  script(src='/assets/paperDashboardPro/js/paper-dashboard.js?v=1.2.1')
  // Sharrre Library
  script(src='/assets/paperDashboardPro/js/jquery.sharrre.js')
  // Paper Dashboard PRO DEMO methods, don't include it in your project!
  script(src='/assets/paperDashboardPro/js/demo.js')
  script(src='/assets/paperDashboardPro/js/scheduler.js')
  script(type='text/javascript').
    $(document).ready(function(){
      var restype = $('#restype').val()
      var room_type_id;
      var girl_room;
      var boy_room;
      var girl_room_qty;
      var boy_room_qty;
      var date = !{JSON.stringify(date)}

      if(restype == 'multiple')
        {
          $.post('selectTime/queryCommon').done(data=>{
            room_type_id= data.common[0].room_type_id
            girl_room = data.girls[0].room_id
            girl_room_qty = data.girls[0].bed_qty

            boy_room = data.boys[0].room_id
            boy_room_qty = data.boys[0].bed_qty
          })
          $.post('selectTime/queryRoom').done(data=>{
            for(var i=0; i<data.length;i++)
              {
                if(data[i].room_type_id==room_type_id)
                  {
                    $('#fullCalendar').fullCalendar('addResource',{
                    id: 'common',
                    title: 'common rooms',
                    })
                  }
                else 
                  {
                      $('#fullCalendar').fullCalendar('addResource',{
                      id: data[i].room_id,
                      title: data[i].room_name,
                      })
                  }
              }
              $.post('selectTime/addResource/Multiple').done(data=>{
                var saveArea;
                var array = [];
                console.log(array)
                for(var i=0; i<data.length;i++)
                  {
                    var points = 0;
                    for(var k=0; k<array.length;k++)
                    {
                      if(array[k].dateTime == data[i].walkin_date+' '+data[i].walkin_start_time){
                        points = 1;
                        array[k].roomDetails.push({
                          roomId:data[i].room_id,
                          roomName:data[i].room_name,
                          roomOrigQty:data[i].bed_qty,
                          roomType: data[i].room_type_id})
                      }
                    }
                    if(points == 0){
                      var object= {
                        roomDetails: [{
                          roomId:data[i].room_id,
                          roomName:data[i].room_name,
                          roomOrigQty:data[i].bed_qty,
                          roomType: data[i].room_type_id}],
                        dateTime: data[i].walkin_date+' '+data[i].walkin_start_time};
                      array.push(object)
                    }
                  }
                  console.log(array)
                  console.log(data)
                for(var t=0; t<array.length;t++){
                  var title2save='';
                  //- var saveGirlQty = girl_room_qty;
                  //- var saveBoyQty = boy_room_qty;
                  var desc='';
                  var start = array[t].time;
                  var end = moment(start);
                  for(var d=0; d<array[t].roomDetails.length; d++){
                    for(var f=0; f<data.length; f++){
                      var dateTimeNow = data[f].walkin_date+" "+data[f].walkin_start_time;
                      //- console.log(dateTimeNow)
                      //- console.log(array[t].dateTime)
                      //- console.log(moment(dateTimeNow).isSame(array[t].dateTime))
                      if(data[f].room_id == array[t].roomDetails[d].roomId && moment(dateTimeNow).isSame(array[t].dateTime)){
                        array[t].roomDetails[d].roomOrigQty = eval(array[t].roomDetails[d].roomOrigQty+'-'+data[f].bed_occupied)
                      }
                      if(f == (data.length-1)){
                        title2save = "\n"+title2save+" "+array[t].roomDetails[d].roomName+" Remaining Beds: "+array[t].roomDetails[d].roomOrigQty;
                      }
                    }
                    if(d == (array[t].roomDetails.length-1)){
                      $('#fullCalendar').fullCalendar('renderEvent',{
                        resourceId: 'common',
                        title: "Remaining Bed",
                        title2: title2save,
                        description: 'WALA',
                        start: moment(array[t].dateTime).format(),
                        end: moment(array[t].dateTime).add(5,'m').format()
                        },true)
                    }
                  }

                }

              })
          })
          }
          else if (restype == 'single')
            {
              $.post('selectTime/query').done(data=>{
                for(var i=0; i<data.length;i++)
                  {
                    $('#fullCalendar').fullCalendar('addResource', {
                    id: data[i].room_id,
                    title: data[i].room_name,
                    occupancy: data[i].bed_qty
                    })

                    //- BACKGROUND COLOR 
                    $.post('selectTime/addResource',{id:data[i].room_id,datePick:date.date}).done(data=>{
                      var newQnty = data[0].bed_qty - data[0].occupied
                      var color = '#FF232'
                      for(var i=0; i<data.length;i++)
                        {

                          var occupied = data[i].bed_occupied
                          var bed_qnty = data[i].bed_qty
                          console.log('BED_QNTY '+bed_qnty)
                          var test = data[i].walkin_date+' '+data[i].walkin_start_time;
                      if(i>0)
                        {
                          var test2 = data[i-1].walkin_date+' '+data[i-1].walkin_end_time;
                          console.log('TEST: '+test+' TEST2: '+test2)
                          console.log(moment(test).isSameOrAfter(test2))
                          if(moment(test).isSameOrAfter(test2))
                            {
                              newQnty = eval(data[0].bed_qty+'-'+occupied)
                              console.log('OCCUPIED '+occupied)
                            }
                          else
                            {
                              console.log('pasok dito')
                              newQnty = eval(newQnty+'-'+occupied)
                              console.log(newQnty)
                            }
                        if(newQnty<=16){
                          color = '#ffe6b3' //kunwari red
                        }
                        if(newQnty<=5){
                          color = '#FFA500' //kunwari red
                        }
                        if(newQnty<=0){
                          color = '#FF0000' //kunwari red
                        }
                        }
                        test = moment(test).format('YYYY-MM-DD HH:mm')
                        test2 = moment(test2).format('YYYY-MM-DD HH:mm')
                        var TIMESTART = data[i].walkin_start_time
                        var TIMEEND = data[i].walkin_end_time
                        var Tstart = data[i].walkin_date +' '+data[i].walkin_start_time
                        var Timestart = data[i].walkin_date +' '+data[i].walkin_start_time
                        var Timeend = data[i].walkin_date +' '+data[i].walkin_end_time;
                        var newT = moment(Timeend).add(5,'m').format()
                        var Tnew = moment(endTime).add(5,'m').format()
                        var startTime = moment(Timestart).format()
                        var endTime= moment(Timeend).format()
                          //- var occupied = data[i].bed_occupied
                          //- var bed_qnty = data[i].bed_qty

                          //- var TIMESTART = data[i].walkin_start_time
                          //- var TIMEEND = data[i].walkin_end_time
                          //- var newQnty = bed_qnty - occupied
                          //- var Tend = data[i].walkin_date +' '+data[i].walkin_end_time
                          //- var Timestart = data[i].walkin_date +' '+data[i].walkin_start_time
                          //- var Timeend = data[i].walkin_date +' '+data[i].walkin_end_time;
                          //- var newT = moment(Timeend).add(5,'m').format()
                          //- var startTime = moment(Timestart).format()
                          //- var endTime= moment(Timeend).format()
                          //- if(newQnty<=16){
                          //-   color = '#ffb31a' //kunwari red
                          //- }
                          //- if(newQnty<=5){
                          //-   color = '#FFA500' //kunwari red
                          //- }
                          //- if(newQnty<=0){
                          //-   color = '#FF0000' //kunwari red
                          //- }
                      
                          $('#fullCalendar').fullCalendar('renderEvent',{
                            resourceId: data[i].room_id,
                            title: "Remaining Bed "+newQnty,
                            title2: "START TIME: "+TIMESTART+" END TIME: "+TIMEEND+" "+newQnty,
                            description: data[i].room_name+" ",
                            start: startTime,
                            end: newT,
                            rendering: 'background',
                            backgroundColor: color
                          },true)
                        }
                      })



                    //- YUNG EVENT MISMO
                    $.post('selectTime/addResource',{id:data[i].room_id,datePick:date.date}).done(data=>{
                      var newQnty = data[0].bed_qty - data[0].occupied
                      
                      var color = '#FF232' // kunwari blue
                      for(var i=0; i<data.length;i++)
                        {
                          var occupied = data[i].bed_occupied
                          var bed_qnty = data[i].bed_qty
                          console.log('BED_QNTY '+bed_qnty)
                          var test = data[i].walkin_date+' '+data[i].walkin_start_time;
                      if(i>0)
                        {
                          var test2 = data[i-1].walkin_date+' '+data[i-1].walkin_end_time;
                          console.log('TEST: '+test+' TEST2: '+test2)
                          console.log(moment(test).isSameOrAfter(test2))
                          if(moment(test).isSameOrAfter(test2))
                            {
                              newQnty = eval(data[0].bed_qty+'-'+occupied)
                              console.log('OCCUPIED '+occupied)
                            }
                          else
                            {
                              console.log('pasok dito')
                              newQnty = eval(newQnty+'-'+occupied)
                              console.log(newQnty)
                            }
                        if(newQnty<=16){
                          color = '#ffb31a' //kunwari red
                        }
                        if(newQnty<=5){
                          color = '#FFA500' //kunwari red
                        }
                        if(newQnty<=0){
                          color = '#FF0000' //kunwari red
                        }
                        }
                      test = moment(test).format('YYYY-MM-DD HH:mm')
                      test2 = moment(test2).format('YYYY-MM-DD HH:mm')
                      var TIMESTART = data[i].walkin_start_time
                      var TIMEEND = data[i].walkin_end_time
                      var Tstart = data[i].walkin_date +' '+data[i].walkin_start_time
                      var Timestart = data[i].walkin_date +' '+data[i].walkin_start_time
                      var Timeend = data[i].walkin_date +' '+data[i].walkin_start_time;
                      var newT = moment(Timeend).add(5,'m').format()
                      var Tnew = moment(endTime).add(5,'m').format()
                      var startTime = moment(Timestart).format()
                      var endTime= moment(Timeend).format()
                      if(TIMESTART == data[i].walkin_start_time)
                        {
                          $('#fullCalendar').fullCalendar('renderEvent',{
                            resourceId: data[i].room_id,
                            title: "Remaining Bed "+newQnty,
                            title2: "START TIME: "+TIMESTART+" END TIME: "+TIMEEND,
                            title3: newQnty,
                            description: data[i].room_name+" ",
                            start: startTime,
                            end: newT,
                            color: color
                          },true)
                        }
                      }
                      console.log(color)
                    })
                  }

          })
          }

              //- $('#fullCalendar').fullcalendar('renderEvent',{
              //-   id: 1,
              //-   resourceId: '9',
              //-   title: 'AAAAA',
              //-   start: '2018-08-17T13:30:00',
              //-   end: '2018-08-17T14:30:00'
              //- },true)
        })
  script.
      $(document).ready(function(){
        var scriptSession = !{JSON.stringify(reqSession)};
        console.log(scriptSession)
        var opening_time= scriptSession.utilities.opening_time
        var closing_time= scriptSession.utilities.closing_time
        console.log(opening_time+" "+closing_time)
        var customerId= $('#Id').val()
        var date = !{JSON.stringify(date)}
        var reservetype = !{JSON.stringify(restype)}
        var male = !{JSON.stringify(male)}
        var female = !{JSON.stringify(female)}
        $('#fullCalendar').fullCalendar({
          header: {
              left:   'title',
              center: '',
              right:  ''
          },
          defaultView: 'agendaDay',
          nowIndicator: true,
          groupByResource: true,
          defaultDate: moment(date.date, "MM-DD-YYYY"),
          slotDuration: "00:05:00",
          minTime: "12:00",
          maxTime: "25:40",
          scrollTime: "01:00", 
          schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
          resources: [
            
          ],
          dayClick: function(date, jsEvent, view, resource) {
            var timeNow = moment().format('YYYY-MM-DD HH:mm')
            //- var businessHours = reqSession.utilities.businessHours
            var businessHoursDate = moment().format('YYYY-MM-DD')
            var businessHours = businessHoursDate+' 13:00'
            var businessHoursTime = '13:00'
            var kahitano = date.format('YYYY-MM-DD HH:mm')
            var kahitanotime = date.format('HH:mm')
            if(moment(kahitano).isSameOrAfter(businessHours) && kahitanotime >= businessHoursTime && moment(kahitano).isSameOrAfter(timeNow))
            {
              var timePicked= date.format('hh:mm A')
              var datePicked = !{JSON.stringify(date)}
              swal({
                title: "You clicked " + date.format('hh:mm A')+" From "+resource.title,
                text: "Are you sure?",
                icon: "info",
                buttons: ["Cancel","Proceed"],
                dangerMode: true
                
              }).then((proceed) => {
                if(proceed)
                {
                  location.href=`/bookreservation?time=${timePicked}&date=${datePicked.date}&room=${resource.title}&roomId=${resource.id}&reservetype=${reservetype}&male=${male}&female=${female}`
                }
                else
                {

                }
                });
              }
              else 
              {

              }
            //- alert(' you clicked ' + date.format('hh:mm A') + ' from '+ resource.title);
          },
          select: function(startDate, endDate, jsEvent, view, resource) {
            //- alert('selected ' + startDate.format() + ' to ' +resource.title);
          },
          businessHours: {
            // days of week. an array of zero-based day of week integers (0=Sunday)
            dow: [ 1, 2, 3, 4, 5, 6, 7 ], // Monday - Thursday

            start: opening_time, 
            end: closing_time, 
          },
          eventRender: function(eventObj, $el) {
            $el.popover({
              title: eventObj.description,
              content: eventObj.title2,
              trigger: 'hover',
              placement: 'top',
              container: 'body'
            });
          },
          eventClick: function(eventObj) {
            var timeNow = moment().format('YYYY-MM-DD HH:mm')
            //- var businessHours = reqSession.utilities.businessHours
            var businessHoursDate = moment().format('YYYY-MM-DD')
            var businessHours = businessHoursDate+' 13:00'
            var businessHoursTime = '13:00'
            var kahitano = eventObj.start.format('YYYY-MM-DD HH:mm')
            var kahitanotime = eventObj.start.format('HH:mm')
            var dateStart= eventObj.start
            if (moment(kahitano).isSameOrAfter(businessHours) && kahitanotime >= businessHoursTime && moment(kahitano).isSameOrAfter(timeNow)) 
            {
              var timePicked= eventObj.start.format('hh:mm A')
              var datePicked = !{JSON.stringify(date)}
              swal({
                title: "You clicked " + eventObj.start.format('hh:mm A')+" From "+eventObj.description+" "+eventObj.title3,
                text: "Are you sure?",
                icon: "info",
                buttons: ["Cancel","Proceed"],
                dangerMode: true
                
              }).then((proceed) => {
                if(proceed)
                {
                  location.href=`/bookreservation?time=${timePicked}&date=${datePicked.date}&room=${eventObj.description}&roomId=${eventObj.resourceId}&reservetype=${reservetype}&male=${male}&female=${female}`
                }
                else
                {

                }
                });
            } 
          },
          //- events: [
            
          //- ]
        });
        //- $('#fullCalendar').fullCalendar('gotoDate', date.date )
    });
    
  script.
    $(document).ready(function() {
      var interval = setInterval(function() {
          var momentNow = moment();
          $('#date-part').html(momentNow.format('YYYY MMMM DD') + ' '
                              + momentNow.format('dddd')
                              .substring(0,3).toUpperCase());
          $('#time-part').html(momentNow.format('A hh:mm:ss'));
      }, 100);
      
      $('#stop-interval').on('click', function() {
          clearInterval(interval);
      });
      //- $('#calendar').val('')
      });